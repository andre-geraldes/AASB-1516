<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
        <style>
      /* disable text selection */
      svg *::selection {
         background : transparent;
      }

      svg *::-moz-selection {
         background:transparent;
      }

      svg *::-webkit-selection {
         background:transparent;
      }
      rect.selection {
        stroke          : #333;
        stroke-dasharray: 4px;
        stroke-opacity  : 0.5;
        fill            : transparent;
      }

      rect.cell-border {
        stroke: #eee;
        stroke-width:0.3px;
      }

      rect.cell-selected {
        stroke: rgb(51,102,153);
        stroke-width:0.5px;
      }

      rect.cell-hover {
        stroke: #F00;
        stroke-width:0.3px;
      }

      text.mono {
        font-size: 9pt;
        font-family: Consolas, courier;
        fill: #aaa;
      }

      text.text-selected {
        fill: #000;
      }

      text.text-highlight {
        fill: #c00;
      }
      text.text-hover {
        fill: #00C;
      }

      #tooltip {
        position: absolute;
        width: 200px;
        height: auto;
        padding: 10px;
        background-color: white;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        pointer-events: none;
      }

      #tooltip.hidden {
        display: none;
      }

      #tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-size: 12px;
        line-height: 20px;
      }
    </style>
    </meta>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Results</title>

    <!-- Core CSS -->
    <link href="css/basic.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
    body {
        padding-top: 50px;
        /* Required padding for .navbar-fixed-top. Remove if using .navbar-static-top. Change if height of navigation changes. */
    }
    </style>


</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Home</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="table.html">Results</a>
                    </li>
                    <li>
                        <a href="about.html">About</a>
                    </li>
                    <li>
                        <a href="contacts.html">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Content -->
    <div class="container">

        <div class="row">
            <div class="col-lg-12 text-center">
                <h1 style="color:rgb(23, 104, 150)">Results</h1>
                <hr>
                <h6 style="color:#e28700; display:inline;"><img src="/img/alert.jpg" style="width:27px; height:22px"> If the data displayed is incorrect, refresh the page please.</h6>

                <div>
                   <!-- list of events with their color by default-->
                    <table align="center">
                        <tr>
                            <td>
                                <div style="border-radius:5px 20px; background-color:green; width:50px;"><h5 style="color:white">AMP</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#89C35C; width:80px;"><h5 style="color:white">HOMDEL</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#0000A0; width:40px;"><h5 style="color:white">UP</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#82CAFA; width:60px;"><h5 style="color:white">DOWN</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#feb3e7; width:60px;"><h5 style="color:white">HYPER</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#a649ee; width:50px;"><h5 style="color:white">HYPO</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#ad0000; width:60px;"><h5 style="color:white">TRUNC</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#ff0000; width:90px;"><h5 style="color:white">MISSENCE</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#ff7658; width:100px;"><h5 style="color:white">FRAMESHIFT</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#da8900; width:60px;"><h5 style="color:white">SPLICE</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:orange; width:80px;"><h5 style="color:white">DELETION</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#fafa00; width:70px;"><h5 style="color:#919191">DELINS</h5></div>
                            </td>
                            <td>
                                <div style="border-radius:5px 20px; background-color:#fff598; width:90px;"><h5 style="color:#919191">INSERTION</h5></div>
                            </td>
                        </tr>
                    </table>
                </div>
    <p></p>
<!--  will have results-->
<div id="results">

    <div id="tooltip" class="hidden">
        <p><span id="value"/></p>
    </div>
    <!--d3 script, necessary for table sorting in real-time-->
    <script src="http://d3js.org/d3.v3.min.js"></script>
<!--    multiple selects with choices in a dropdown fashion, to allow the user the possibility to change the colors of the events-->
    <select id="AMP" style="display: inline; width:65px; background: green; color: white;" onChange="this.style.backgroundColor=this.options[this.selectedIndex].style.backgroundColor">
        <option value=green style="background: green;" selected>AMP</option>;
        <option value=#89C35C style="background: #89C35C;">lightgreen</option>;
        <option value=#0000A0 style="background: #0000A0;">blue</option>;
        <option value=#82CAFA style="background: #82CAFA;">lightblue</option>;
        <option value=#feb3e7 style="background: #feb3e7;">pink</option>;
        <option value=#a649ee style="background: #a649ee;">purple</option>;
        <option value=#70706d style="background: #70706d;">grey</option>;
        <option value=black style="background: black;">black</option>;
    </select>
    <select id="HOMDEL" style="display: inline; width:90px; background: #89C35C; color: white;" onChange="this.style.backgroundColor=this.options[this.selectedIndex].style.backgroundColor">
        <option value=green style="background: green;">green</option>;
        <option value=#89C35C style="background: #89C35C;" selected>HOMDEL</option>;
        <option value=#0000A0 style="background: #0000A0;">blue</option>;
        <option value=#82CAFA style="background: #82CAFA;">lightblue</option>;
        <option value=#feb3e7 style="background: #feb3e7;">pink</option>;
        <option value=#a649ee style="background: #a649ee;">purple</option>;
        <option value=#70706d style="background: #70706d;">grey</option>;
        <option value=black style="background: black;">black</option>;
    </select>
    <select id="UP" style="display: inline; width:55px; background: #0000A0; color: white;" onChange="this.style.backgroundColor=this.options[this.selectedIndex].style.backgroundColor">
        <option value=green style="background: green;">green</option>;
        <option value=#89C35C style="background: #89C35C;">lightgreen</option>;
        <option value=#0000A0 style="background: #0000A0;" selected="">UP</option>;
        <option value=#82CAFA style="background: #82CAFA;">lightblue</option>;
        <option value=#feb3e7 style="background: #feb3e7;">pink</option>;
        <option value=#a649ee style="background: #a649ee;">purple</option>;
        <option value=#70706d style="background: #70706d;">grey</option>;
        <option value=black style="background: black;">black</option>;
    </select>
    <select id="DOWN" style="display: inline; width:75px; background: #82CAFA; color: white;" onChange="this.style.backgroundColor=this.options[this.selectedIndex].style.backgroundColor">
        <option value=green style="background: green;">green</option>;
        <option value=#89C35C style="background: #89C35C;">lightgreen</option>;
        <option value=#0000A0 style="background: #0000A0;">blue</option>;
        <option value=#82CAFA style="background: #82CAFA;" selected>DOWN</option>;
        <option value=#feb3e7 style="background: #feb3e7;">pink</option>;
        <option value=#a649ee style="background: #a649ee;">purple</option>;
        <option value=#70706d style="background: #70706d;">grey</option>;
        <option value=black style="background: black;">black</option>;
    </select>
    <select id="HYPER" style="display: inline; width:80px; background: #feb3e7; color: white;" onChange="this.style.backgroundColor=this.options[this.selectedIndex].style.backgroundColor">
        <option value=green style="background: green;">green</option>;
        <option value=#89C35C style="background: #89C35C;">lightgreen</option>;
        <option value=#0000A0 style="background: #0000A0;">blue</option>;
        <option value=#82CAFA style="background: #82CAFA;">lightblue</option>;
        <option value=#feb3e7 style="background: #feb3e7;" selected>HYPER</option>;
        <option value=#a649ee style="background: #a649ee;">purple</option>;
        <option value=#70706d style="background: #70706d;">grey</option>;
        <option value=black style="background: black;">black</option>;
    </select>
    <select id="HYPO" style="display: inline; width:75px; background: #a649ee; color: white;" onChange="this.style.backgroundColor=this.options[this.selectedIndex].style.backgroundColor">
        <option value=green style="background: green;">green</option>;
        <option value=#89C35C style="background: #89C35C;">lightgreen</option>;
        <option value=#0000A0 style="background: #0000A0;">blue</option>;
        <option value=#82CAFA style="background: #82CAFA;">lightblue</option>;
        <option value=#feb3e7 style="background: #feb3e7;">pink</option>;
        <option value=#a649ee style="background: #a649ee;" selected>HYPO</option>;
        <option value=#70706d style="background: #70706d;">grey</option>;
        <option value=black style="background: black;">black</option>;
    </select>
    <!--button that refreshes the table whith the options from the user-->
    <button type="button" class="btn btn-primary btn-xs" onclick="run_script()" style="float: center;">Use this colors</button>
     <!--button that calls toPdf() function, that basicaly generates the pdf and when it´s done a button for it´s download will appear-->
    <button id="pdfbutton" type="button" class="btn btn-primary btn-xs" onclick="toPdf()">PDF</button>


    <div>
        <br>
        <h5 style="color:rgb(23, 104, 150); display:inline;">Order:</h5>
       <!-- dropdown select with table's available sorting types -->
        <select id="order">
            <!--order from input file-->
            <option value="default" selected>by file default</option>
            <!--sort by hierarchy clustering-->
            <option value="hclust">by cluster</option>
            <!--sort by ascending/decreasing mutation values Note* this option do nothing when chosen from the dropdown, it is activated when a table's label from row/column is clicked-->
            <option value="custom">by label</option>
        </select>
    </div>
    <!--this is where the pdf's download button will appear-->
    <div id ="download">

    </div>
    <!--this is where the table with the results from the input file will appear-->
    <div id="chart" style='overflow:auto; width:100%; height:100%;'></div>

</div>
</div>
<!-- /.row -->
</div>
<!-- /.container -->

<!-- jQuery Version 1.11.1 -->
<script src="js/jquery.js"></script>

<!-- Core JavaScript -->
<script src="js/basic.min.js"></script>

<!--this is where our javascript funtions are defined-->
<script type="text/javascript">

    //functions to run when the page is loaded
    $(document).ready(function() {
        //function to fill the table with default settings
        d3.selectAll("svg > *").remove();
        run_script();
    });

   //function that populates the table
function run_script(){
    //emptys chart div to give place a new table
    $("#chart").empty();
    //using d3 we fetch information from a json file containing the names for columns and rows
    d3.json("cancer.json", function(cancer) {
    var matrix = [],
        matrixC = [],
        //from json file store the column and row names respectively
        gene = cancer.gene,
        caseID = cancer.caseID,
        //their length
        rowL = caseID.length,
        columnL = gene.length;

        //fetch clustering index
    var clustR = cancer.row,
        clustC = cancer.column,
        //their length
        clustRL = clustR.length,
        clustCL = clustC.length;

    //Get colors from selects
    var amp = $("#AMP").val();
    var del = $("#HOMDEL").val();
    var up = $("#UP").val();
    var down = $("#DOWN").val();
    var hyper = $("#HYPER").val();
    var hypo = $("#HYPO").val();

    //margin options
    var margin = { top: 150, right: 50, bottom: 50, left: 100 },
        cellSize=15;
        col_number=columnL;
        row_number=rowL;
        width = cellSize*col_number, // - margin.left - margin.right,
        height = cellSize*row_number , // - margin.top - margin.bottom,
        colLabel=[],
        rowLabel =[]
        gene.forEach(function(na,i) {
            colLabel[i]=gene[i].name;//povoate columns's names
        });
        caseID.forEach(function(cn,i) {
            rowLabel[i]=caseID[i].name;//povoate rows's names
        });
        legendElementWidth = cellSize*2.5,
        colorBuckets = 21,
        colors = ['white',amp,del,up,down,hyper,hypo,'#ad0000', '#ff0000', '#ff7658', '#da8900', 'orange', '#fafa00','#fff598'];// colors to use on events

        var hcrow = [];
        var hccol = [];
        clustR.forEach(function(na,i) {
            hcrow[i]= clustR[i].name;// row clustering order
        });
        clustC.forEach(function(cn,i) {
            hccol[i]= clustC[i].name;// column clustering order
        });
    //from a tsv file we fetch positions of the events
    d3.tsv("cancer.tsv",
    function(d) {
        //returns the position and event value/type from each line of the tsv file
        return {
            row:   +d.row_idx,
            col:   +d.col_idx,
            value: d.value
            };
    },
    function(error, data) {
    // function called to get a color from an index
    var colorScale = d3.scale.quantile()
        .domain([0, 13]) // domain of colors with the itial and final index
        .range(colors);

    var svg = d3.select("#chart").append("svg") // append svg element (the table) with d3 select, to create a dynamic table
		//apply size to the table
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")//  used to group SVG shapes together
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
        ;
    var rowSortOrder=false;
    var colSortOrder=false;
	//povoates the labels of table's rows
    var rowLabels = svg.append("g")//  used to group SVG shapes together
        .selectAll(".rowLabelg")
        .data(rowLabel)//get values from array rowLabel earlier populated
        .enter()
        .append("text")//type of element
        .text(function (d) { return d; })
        .attr("x", 0)
        .attr("y", function (d, i) { return hcrow.indexOf(i+1) * cellSize; })//clustering order
        .style("text-anchor", "end")
        .attr("transform", "translate(-1," + cellSize / 1.5 + ")")
        .attr("class", function (d,i) { return "rowLabel mono r"+i;} )
        .on("mouseover", function(d) {d3.select(this).classed("text-hover",true);})//highlights selected
        .on("mouseout" , function(d) {d3.select(this).classed("text-hover",false);})//undo above
        .on("click", function(d,i) {rowSortOrder=!rowSortOrder; sortbylabel("r",i,rowSortOrder);d3.select("#order").property("selectedIndex", 2).node().focus();;})//order by clicked label, also changes the order select to "by label""
        ;
	//povoates the labels of table's columns
    var colLabels = svg.append("g")//used to group SVG shapes together
        .selectAll(".colLabelg")
        .data(colLabel)// get values from array colLabel earlier populated
        .enter()
        .append("text")//type of element
        .text(function (d) { return d; })
        .attr("x", 0)
        .attr("y", function (d, i) { return hccol.indexOf(i+1) * cellSize; })//clustering order
        .style("text-anchor", "left")
        .attr("transform", "translate("+cellSize/2 + ",-6) rotate (-90)")
        .attr("class",  function (d,i) { return "colLabel mono c"+i;} )
        .on("mouseover", function(d) {d3.select(this).classed("text-hover",true);})//highlights selected
        .on("mouseout" , function(d) {d3.select(this).classed("text-hover",false);})//undo above
        .on("click", function(d,i) {colSortOrder=!colSortOrder;  sortbylabel("c",i,colSortOrder);d3.select("#order").property("selectedIndex", 2).node().focus();;})//order by clicked label
        ;

	//svg elements that represents a cell in the table

	//first element that represents the first event of three possible
    var heatMap = svg.append("g").attr("class","g3")
        .selectAll(".cellg")
        .data(data,function(d){return d.row+":"+d.col; })// index of the element in the table
        .enter()
        .append("rect")// type of element
        .attr("x", function(d) { return hccol.indexOf(d.col) * cellSize; }) // position in x
        .attr("y", function(d) { return hcrow.indexOf(d.row) * cellSize; }) // position in y
        .attr("class", function(d){return "cell cell-border cr"+(d.row-1)+" cc"+(d.col-1);})
        .attr("width", cellSize)
        .attr("height", cellSize)
        .style("fill", function(d) {var s=""+d.value;//d.value has the events of a specific cell
    var i=s.charAt(0);// gets the first event and stores it in a variable

    if(isNaN(i)){// if it is a mutation(it's not numeric) Note* on the tsv file, mutations have a letter to represent them, other events a number
        return colorScale(mutToid(i)); // mutToid (gives a index of that mutation on the colour array), colorScale gets the colour code.
    }
    else{
        return colorScale(parseInt(i));//convert the variable i to integer and gets it's color code.
    }

    })
	//when a cell is moused-over
    .on("mouseover", function(d){
    //highlight text
    d3.select(this).classed("cell-hover",true);
    d3.selectAll(".rowLabel").classed("text-highlight",function(r,ri){ return ri==(d.row-1);});//highlights the respective row label
    d3.selectAll(".colLabel").classed("text-highlight",function(c,ci){ return ci==(d.col-1);});//highlights the respective column label

    //Update the tool-tip position and value
    d3.select("#tooltip")
	//tool-tip position
     .style("left", (d3.event.pageX-50) + "px")
     .style("top", (d3.event.pageY-50) + "px")
     .select("#value")
     .text("CaseID: "+rowLabel[d.row-1]+", Gene: "+colLabel[d.col-1]+"\nevent type: "+idToMUT((""+d.value).charAt(0))+"\nrow-col-idx:"+d.row+","+d.col);//text in tool-tip
    //Show the tool-tip
    d3.select("#tooltip").classed("hidden", false);//shows the tool-tip
    })
	//when the mouse leaves the cell
    .on("mouseout", function(){
	//undo previous changes of mouse-over like hide the tool-tip
    d3.select(this).classed("cell-hover",false);
    d3.selectAll(".rowLabel").classed("text-highlight",false);
    d3.selectAll(".colLabel").classed("text-highlight",false);
    d3.select("#tooltip").classed("hidden", true);
    })
    ;

	//svg element that represents the second event in d.value it is very similar to the element above so only what is different will be explained
    var newMpap = svg.append("g").attr("class","g3")
        .selectAll(".cellg")
        .data(data,function(d){return d.row+":"+d.col; })
        .enter()
        .append("rect")
        .attr("x", function(d) { return hccol.indexOf(d.col) * cellSize; })
        .attr("y", function(d) { return hcrow.indexOf(d.row) * cellSize; })
        .attr("class", function(d){return "cell cell-border cr"+(d.row-1)+" cc"+(d.col-1);})
        .attr("width",  function(d) {var s=""+d.value;
        if(s.length > 1){ return cellSize/2 ;}else{ return cellSize;}})//if another event exists draw it in the same cell but in half the space, so the two of them can be visible
        //																 otherwise overwrites the element above.
		.attr("height", cellSize)
        .style("fill", function(d) {var s=""+d.value;
        if(s.length > 1){ i=s.charAt(1);}else{ i=s.charAt(0);}//if a second element exists store its value on a variable if it doesn't exist stores the first event.

        if(isNaN(i)){
            return colorScale(mutToid(i));
        }
        else { return colorScale(parseInt(i));} })
    .on("mouseover", function(d){
    //highlight text
    d3.select(this).classed("cell-hover",true);
    d3.selectAll(".rowLabel").classed("text-highlight",function(r,ri){ return ri==(d.row-1);});
    d3.selectAll(".colLabel").classed("text-highlight",function(c,ci){ return ci==(d.col-1);});
    s1 = ""+d.value;
    if(s1.length >1){mut = idToMUT((s1).charAt(1));}else{mut = idToMUT((s1).charAt(0));}
    //Update the tooltip position and value
    d3.select("#tooltip")
     .style("left", (d3.event.pageX-50) + "px")
     .style("top", (d3.event.pageY-50) + "px")
     .select("#value")
     .text("CaseID: "+rowLabel[d.row-1]+", Gene: "+colLabel[d.col-1]+"\nevent type: "+ mut+"\nrow-col-idx:"+d.row+","+d.col);
    d3.select("#tooltip").classed("hidden", false);
    })
    .on("mouseout", function(){
    d3.select(this).classed("cell-hover",false);
    d3.selectAll(".rowLabel").classed("text-highlight",false);
    d3.selectAll(".colLabel").classed("text-highlight",false);
    d3.select("#tooltip").classed("hidden", true);
    })
    ;

	//svg element that represents the third event, further events won't be represented. This element will have stroke only shape
    var strokMap = svg.append("g").attr("class","g3")
        .selectAll(".cellg")
        .data(data,function(d){return d.row+":"+d.col; })
        .enter()
        .append("rect")
        .attr("x", function(d) { return hccol.indexOf(d.col) * cellSize; })
        .attr("y", function(d) { return hcrow.indexOf(d.row) * cellSize; })
        .attr("class", function(d){return "cell cell-border cr"+(d.row-1)+" cc"+(d.col-1);})
        .attr("width", cellSize)
        .attr("height", cellSize)
        .style("fill", "none")//this element has no fill
        .style("stroke",function(d){s3 = ""+d.value; if(s3.length >2){ i=s3.charAt(2); if(isNaN(i)){return colorScale(mutToid(i));} else {return colorScale(parseInt(s3.charAt(2)));} } else{return "none";}} )
        .style("stroke-width",3)//adding the stroke
        .on("mouseover", function(d){

    d3.select(this).classed("cell-hover",true);
    d3.selectAll(".rowLabel").classed("text-highlight",function(r,ri){ return ri==(d.row-1);});
    d3.selectAll(".colLabel").classed("text-highlight",function(c,ci){ return ci==(d.col-1);});
    s1 = ""+d.value;
    if(s1.length >2){mut = idToMUT((s1).charAt(2));}else{mut = idToMUT((s1).charAt(0));}
    //Update the tooltip position and value
    d3.select("#tooltip")
        .style("left", (d3.event.pageX-50) + "px")
        .style("top", (d3.event.pageY-50) + "px")
        .select("#value")
        .text("CaseID: "+rowLabel[d.row-1]+", Gene: "+colLabel[d.col-1]+"\nevent type: "+ mut+"\nrow-col-idx:"+d.row+","+d.col);
    d3.select("#tooltip").classed("hidden", false);
    })
    .on("mouseout", function(){
    d3.select(this).classed("cell-hover",false);
    d3.selectAll(".rowLabel").classed("text-highlight",false);
    d3.selectAll(".colLabel").classed("text-highlight",false);
    d3.select("#tooltip").classed("hidden", true);
    })
    ;



    // function of sorting by label
    function sortbylabel(rORc,i,sortOrder){
        var t = svg.transition().duration(2000);//time it takes to reorder the table (2 seconds)
        var log2r=[];
        var sorted; // sorted is zero-based index
        d3.selectAll(".c"+rORc+i)
        .filter(function(ce){

        log2r.push(valueToInt(ce.value+""));//add values calculated with valueToint to log2r array
        })
        ;
        if(rORc=="r"){ // sort log2ratio of a gene
            sorted=d3.range(col_number).sort(function(a,b){ if(sortOrder){ return log2r[b]-log2r[a];}else{ return log2r[a]-log2r[b];}});// sort order can be from min to max or vice-versa. Apply d3.sort function
            t.selectAll(".cell")
            .attr("x", function(d) { return sorted.indexOf(d.col-1) * cellSize; })// returns cell's new sorted index on x
            ;
            t.selectAll(".colLabel")
            .attr("y", function (d, i) { return sorted.indexOf(i) * cellSize; })// returns cell's new sorted index on y
            ;
        }else{ // sort log2ratio of a caseID
            sorted=d3.range(row_number).sort(function(a,b){if(sortOrder){ return log2r[b]-log2r[a];}else{ return log2r[a]-log2r[b];}});
            t.selectAll(".cell")
            .attr("y", function(d) { return sorted.indexOf(d.row-1) * cellSize; })
            ;
            t.selectAll(".rowLabel")
            .attr("y", function (d, i) { return sorted.indexOf(i) * cellSize; })
            ;
    }
    }
	//gets the sorting choice from order select and reorders according to that value
    d3.select("#order").on("change",function(){
        order(this.value);
    });

    function order(value){
        if (value=="default"){//elements as they were given on the excel file
            var t = svg.transition().duration(2000);
			//just goes to all cells and gives them the index on the tsv file
            t.selectAll(".cell")
            .attr("x", function(d) { return (d.col - 1) * cellSize; })
            .attr("y", function(d) { return (d.row - 1) * cellSize; })
            ;

            t.selectAll(".rowLabel")
            .attr("y", function (d, i) { return i * cellSize; })
            ;

            t.selectAll(".colLabel")
            .attr("y", function (d, i) { return i * cellSize; })
            ;

        }
		//sort-by clustering gives the index to the cells in hccol and hcrow previously populated
        else if(value=="hclust"){
            var t = svg.transition().duration(2000);
            t.selectAll(".cell")
            .attr("x", function(d) { return hccol.indexOf(d.col) * cellSize; })
            .attr("y", function(d) { return hcrow.indexOf(d.row) * cellSize; })
            ;

            t.selectAll(".rowLabel")
            .attr("y", function (d, i) { return hcrow.indexOf(i+1) * cellSize; })
            ;

            t.selectAll(".colLabel")
            .attr("y", function (d, i) { return hccol.indexOf(i+1) * cellSize; })
            ;
        }
    }

	 //Optional, it will reorder the table to the default type sort
    order("default");

    var sa=d3.select(".g3")
    .on("mousedown", function() {
    if( !d3.event.altKey) {
        d3.selectAll(".cell-selected").classed("cell-selected",false);
        d3.selectAll(".rowLabel").classed("text-selected",false);
        d3.selectAll(".colLabel").classed("text-selected",false);
    }
	//mouse characteristics on selections
    var p = d3.mouse(this);
    sa.append("rect")
    .attr({
    rx      : 0,
    ry      : 0,
    class   : "selection",
    x       : p[0],
    y       : p[1],
    width   : 1,
    height  : 1
    })
    })
    .on("mousemove", function() {
    var s = sa.select("rect.selection");

    if(!s.empty()) {
    var p = d3.mouse(this),
     d = {
         x       : parseInt(s.attr("x"), 10),
         y       : parseInt(s.attr("y"), 10),
         width   : parseInt(s.attr("width"), 10),
         height  : parseInt(s.attr("height"), 10)
     },
     move = {
         x : p[0] - d.x,
         y : p[1] - d.y
     }
    ;

    if(move.x < 1 || (move.x*2<d.width)) {
     d.x = p[0];
     d.width -= move.x;
    } else {
     d.width = move.x;
    }

    if(move.y < 1 || (move.y*2<d.height)) {
     d.y = p[1];
     d.height -= move.y;
    } else {
     d.height = move.y;
    }
    s.attr(d);

     // deselect all temporary selected state objects
    d3.selectAll('.cell-selection.cell-selected').classed("cell-selected", false);
    d3.selectAll(".text-selection.text-selected").classed("text-selected",false);

    d3.selectAll('.cell').filter(function(cell_d, i) {
     if(
         !d3.select(this).classed("cell-selected") &&
             // inner circle inside selection frame
         (this.x.baseVal.value)+cellSize >= d.x && (this.x.baseVal.value)<=d.x+d.width &&
         (this.y.baseVal.value)+cellSize >= d.y && (this.y.baseVal.value)<=d.y+d.height
     ) {

         d3.select(this)
         .classed("cell-selection", true)
         .classed("cell-selected", true);

         d3.select(".r"+(cell_d.row-1))
         .classed("text-selection",true)
         .classed("text-selected",true);

         d3.select(".c"+(cell_d.col-1))
         .classed("text-selection",true)
         .classed("text-selected",true);
     }
    });
    }
    })
    .on("mouseup", function() {
    // remove selection frame
    sa.selectAll("rect.selection").remove();

    // remove temporary selection marker class
    d3.selectAll('.cell-selection').classed("cell-selection", false);
    d3.selectAll(".text-selection").classed("text-selection",false);
    })
    .on("mouseout", function() {
    if(d3.event.relatedTarget.tagName=='html') {
     // remove selection frame
    sa.selectAll("rect.selection").remove();
     // remove temporary selection marker class
    d3.selectAll('.cell-selection').classed("cell-selection", false);
    d3.selectAll(".rowLabel").classed("text-selected",false);
    d3.selectAll(".colLabel").classed("text-selected",false);
    }
    })
    ;
    });
    });
    //Close run_script
}
	//Function that gives a textual representation of an event
    function idToMUT(id){
        if(id=='0')
            {
                return "NONE";
            }
        if(id=='1')
            {
                return "Copy number variation -> AMP";
            }
        if(id=='2')
            {
                return "Copy number variation -> HOMDEL";
            }
        if(id=='3')
            {
                return "Expression -> UP";
            }

        if(id=='4')
            {
                return "Expression -> DOWN";
            }
        if(id=='5')
            {
                return "Metilation -> HYPER";
            }
        if(id=='6')
            {
                return "Metilation -> HYPO";
            }
        if(id=='A'){
        return 'Mutation -> TRUNC';
        }
        if(id=='B'){
        return 'Mutation -> MISSENCE';
        }
        if(id=='C'){
        return 'Mutation -> FRAMESHIFT';
        }
        if(id=='D'){
        return 'Mutation -> SPLICE';
        }
        if(id=='E'){
        return 'Mutation -> DELETION';
        }
        if(id=='F'){
        return 'Mutation -> DELINS';
        }
        if(id=='G'){
        return 'Mutation -> INSERTION';
        }
    }
	//Function that calculates the index os a mutation on the colour's array
    function mutToid(mut){
        if(mut=='A'){
            return 7;
        }
        if(mut=='B'){
            return 8;
        }
        if(mut=='C'){
            return 9;
        }
        if(mut=='D'){
            return 10;
        }
        if(mut=='E'){
            return 11;
        }
        if(mut=='F'){
            return 12;
        }
        if(mut=='G'){
            return 13;
        }
    }

	//function that calculates the value of multiple/one event(s) that occurs in a cell
    function valueToInt(value){
        res=0;
        for(i=0;i<value.length;i++){

        var l = value.charAt(i);
        if(isNaN(l))
        {
        res+=mutValue(l);
        }
        else
        {
        res+=parseInt(l);
        }

        }return res;
    }
	//function that gives a value to a mutation for sorting
	function mutValue(mut){
		if(mut=='A'){
            return 600;
        }
        if(mut=='B'){
            return 450;
        }
        if(mut=='C'){
            return 350;
        }
        if(mut=='D'){
            return 250;
        }
        if(mut=='E'){
            return 200;
        }
        if(mut=='F'){
            return 150;
        }
        if(mut=='G'){
            return 100;
        }

	}

    //Calls php with wkhtmltopdf to create pdf
    function toPdf(){
        if(document.getElementById("downloadImage")){
            remove("downloadImage");
        }
        s = $("#svgE");
        s1 = document.getElementById("svgE");
        v = document.getElementById("chart").innerHTML;

        //Max size of table
        s1 = v.substring(0,5000000);

        //Colors for label
        var amp = $("#AMP").val();
        var del = $("#HOMDEL").val();
        var up = $("#UP").val();
        var down = $("#DOWN").val();
        var hyper = $("#HYPER").val();
        var hypo = $("#HYPO").val();

        $.ajax({
              url: 'tpdf.php',
              type: 'post',
              data: {  "tablePDF" : s1 , "AMP" : amp, "DEL" : del, "UP" : up, "DOWN" : down, "HYPER" : hyper, "HYPO" : hypo},
                success: function(response) {
                       $("#download").append(response);
                    },
              error: function(err) {
                        window.alert("Error on communication!");
                     }
        });
    }

    //Function to remove elements
    function remove(id) {
        return (elem=document.getElementById(id)).parentNode.removeChild(elem);
    }

    //Remove image to download
    function hideIm(){
        remove("downloadImage");
    }

</script>

</body>

</html>
